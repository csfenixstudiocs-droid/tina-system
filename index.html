<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Classic Tina">
    <title>Classic Tina | AI 管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF9; color: #4A443F; scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        .serif { font-family: 'Noto Serif TC', serif; }
        .hidden { display: none !important; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #EBE3DC; border-radius: 10px; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-red { animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .section-card { background: white; border-radius: 1.5rem; border: 1px solid #E6E1DD; box-shadow: 0 4px 20px rgba(0,0,0,0.02); }
        .sticky-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid #E6E1DD; padding-top: var(--safe-top); }
        main { padding-bottom: calc(6rem + var(--safe-bottom)); padding-top: 1rem; }
        .shimmer { background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="min-h-screen custom-scroll">

    <!-- 頂部導航 -->
    <header class="sticky top-0 z-40 sticky-nav px-4 md:px-6 py-3 flex flex-col gap-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-[#8C7B6E] rounded-xl flex items-center justify-center text-white shadow-md">
                    <i data-lucide="sparkles" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl serif font-bold text-[#8C7B6E] tracking-widest uppercase">Classic Tina</h1>
                    <p class="text-[9px] text-stone-400 font-bold tracking-widest uppercase">✨ fenixclub Cloud AI</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- 診斷助手按鈕 -->
                <button onclick="openModal('modal-debug')" class="p-2.5 bg-stone-50 border border-stone-100 text-[#8C7B6E] rounded-xl active:scale-90 transition-all">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                </button>
                <button onclick="openModal('modal-notifications')" class="relative p-2.5 bg-white border border-stone-100 text-stone-400 rounded-xl active:scale-90 transition-all">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notif-badge" class="hidden absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full pulse-red"></span>
                </button>
            </div>
        </div>

        <div class="flex gap-2">
            <div class="relative flex-1">
                <i data-lucide="search" class="absolute left-3.5 top-1/2 -translate-y-1/2 text-stone-300 w-4 h-4"></i>
                <input type="text" id="globalSearch" placeholder="搜尋項目、客人姓名..." onkeyup="handleGlobalSearch()" 
                    class="w-full pl-10 pr-4 py-2.5 bg-white border border-stone-200 rounded-xl text-sm focus:border-[#8C7B6E] outline-none transition-all">
            </div>
            <button onclick="exportToCSV()" class="p-2.5 bg-white border border-stone-200 rounded-xl text-[#8C7B6E] active:bg-stone-50 transition-all shadow-sm">
                <i data-lucide="download" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div id="cloud-status" class="flex items-center justify-center gap-2 py-1 bg-amber-50 text-amber-600 rounded-lg border border-amber-100/30">
            <span id="status-dot" class="w-1.5 h-1.5 bg-amber-500 rounded-full animate-pulse"></span>
            <span class="text-[9px] font-bold uppercase tracking-widest" id="status-text">連線雲端中...</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 space-y-10">
        
        <!-- 加載遮罩 -->
        <div id="loading-overlay" class="fixed inset-0 bg-[#FDFBF9] z-[100] flex flex-col items-center justify-center space-y-6 p-8 text-center transition-opacity duration-500">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-stone-100 border-t-[#8C7B6E] rounded-full animate-spin"></div>
                <i data-lucide="sparkles" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-[#8C7B6E] w-6 h-6"></i>
            </div>
            <div class="space-y-2">
                <p class="serif text-lg text-[#8C7B6E] font-bold tracking-widest">fenixclub 控制台</p>
                <p id="loading-subtext" class="text-xs text-stone-400 animate-pulse uppercase tracking-widest">正在啟動雲端安全連線...</p>
            </div>
            
            <div id="setup-error" class="hidden mt-6 space-y-4 fade-in">
                <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                    <p class="text-[10px] text-red-500 leading-relaxed font-bold">偵測到 404 或連線逾時。<br>這是因為臨時連結已失效，或隱私設定阻擋。</p>
                </div>
                <button onclick="forceRevealApp()" class="w-full bg-[#8C7B6E] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all text-sm">強制進入預覽模式</button>
                <button onclick="window.location.reload()" class="text-stone-400 text-xs underline">重試連線</button>
            </div>
        </div>

        <!-- 快速功能區 -->
        <section class="grid grid-cols-3 gap-3">
            <button onclick="openModal('modal-gown')" class="p-5 section-card active:scale-95 transition-all flex flex-col items-center gap-2 text-center">
                <div class="w-10 h-10 rounded-xl bg-[#8C7B6E]/10 text-[#8C7B6E] flex items-center justify-center shadow-inner"><i data-lucide="plus-square" class="w-5 h-5"></i></div>
                <span class="text-[10px] font-black text-stone-600 uppercase tracking-tighter">新入庫</span>
            </button>
            <button onclick="openModal('modal-customer')" class="p-5 section-card active:scale-95 transition-all flex flex-col items-center gap-2 text-center">
                <div class="w-10 h-10 rounded-xl bg-[#8C7B6E]/10 text-[#8C7B6E] flex items-center justify-center shadow-inner"><i data-lucide="user-plus" class="w-5 h-5"></i></div>
                <span class="text-[10px] font-black text-stone-600 uppercase tracking-tighter">建客人</span>
            </button>
            <button onclick="openModal('modal-rental')" class="p-5 section-card active:scale-95 transition-all flex flex-col items-center gap-2 text-center">
                <div class="w-10 h-10 rounded-xl bg-[#8C7B6E]/10 text-[#8C7B6E] flex items-center justify-center shadow-inner"><i data-lucide="calendar" class="w-5 h-5"></i></div>
                <span class="text-[10px] font-black text-stone-600 uppercase tracking-tighter">租借登記</span>
            </button>
        </section>

        <!-- 區域 1: 庫存 -->
        <section id="sec-inventory" class="fade-in space-y-4">
            <div class="flex items-center justify-between px-2">
                <h2 class="text-lg serif font-bold text-stone-800 flex items-center gap-2"><i data-lucide="shirt" class="w-4 h-4 text-[#8C7B6E]"></i>庫存管理</h2>
                <span id="gown-count" class="text-[8px] font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-full">載入中...</span>
            </div>
            <div class="section-card overflow-hidden overflow-x-auto shadow-sm">
                <table class="w-full text-left text-sm min-w-[500px]">
                    <thead class="bg-stone-50/50 text-stone-400 font-bold border-b border-stone-100 uppercase text-[9px] tracking-widest">
                        <tr><th class="px-5 py-4">服飾名稱</th><th class="px-5 py-4 text-center">狀態</th><th class="px-5 py-4">位置</th><th class="px-5 py-4 text-right">管理</th></tr>
                    </thead>
                    <tbody id="inventory-table" class="divide-y divide-stone-50"></tbody>
                </table>
                <div id="inventory-empty" class="hidden p-12 text-center text-stone-300 italic text-xs uppercase tracking-widest">目前無庫存</div>
            </div>
        </section>

        <!-- 區域 2: 客人 -->
        <section id="sec-customers" class="fade-in space-y-4">
            <div class="flex items-center justify-between px-2">
                <h2 class="text-lg serif font-bold text-stone-800 flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-[#8C7B6E]"></i>客人檔案</h2>
                <span id="cust-count" class="text-[8px] font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-full">載入中...</span>
            </div>
            <div id="customer-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            <div id="customers-empty" class="hidden p-12 text-center text-stone-300 italic text-xs section-card">目前無客人檔案</div>
        </section>

        <!-- 區域 3: 租借排程 -->
        <section id="sec-rentals" class="fade-in space-y-4">
            <div class="flex items-center justify-between px-2">
                <h2 class="text-lg serif font-bold text-stone-800 flex items-center gap-2"><i data-lucide="calendar-days" class="w-4 h-4 text-[#8C7B6E]"></i>租借排程</h2>
                <span id="rent-count" class="text-[8px] font-bold text-stone-400 bg-stone-100 px-2 py-1 rounded-full">載入中...</span>
            </div>
            <div id="rental-list" class="space-y-3"></div>
            <div id="rentals-empty" class="hidden p-12 text-center text-stone-300 italic text-xs section-card border-2 border-dashed border-stone-200">無租借紀錄</div>
        </section>

    </main>

    <!-- Modals -->
    <!-- 診斷與安裝助手 -->
    <div id="modal-debug" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden fade-in border-t-8 border-[#8C7B6E]">
            <div class="p-8 text-center space-y-6">
                <div class="w-16 h-16 bg-[#8C7B6E]/10 text-[#8C7B6E] rounded-2xl flex items-center justify-center mx-auto shadow-inner"><i data-lucide="smartphone" class="w-8 h-8"></i></div>
                <div><h3 class="text-xl serif font-bold text-stone-800">iPhone 穩定使用指南</h3><p class="text-xs text-stone-400 mt-2 leading-relaxed">由於 Apple 的安全機制，臨時預覽連結會失效。建議將此 HTML 檔案部署至永久網址。</p></div>
                <div class="space-y-3">
                    <button onclick="copyAppUrl()" class="w-full bg-[#8C7B6E] text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-all"><i data-lucide="copy" class="w-4 h-4"></i> 複製目前網址</button>
                    <p class="text-[9px] text-stone-500 font-medium">在 Safari 貼上連結後，使用「分享」→「加入主畫面」即可像 App 一樣永久使用。</p>
                </div>
                <button onclick="closeModal('modal-debug')" class="text-stone-300 text-xs font-bold uppercase tracking-widest">關閉視窗</button>
            </div>
        </div>
    </div>

    <!-- 新增庫存 Modal -->
    <div id="modal-gown" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl overflow-hidden fade-in max-h-[85vh] flex flex-col">
            <div class="bg-[#8C7B6E] p-5 text-white flex justify-between items-center shrink-0"><h3 class="font-bold serif">服飾入庫</h3><button onclick="closeModal('modal-gown')" class="p-1"><i data-lucide="x"></i></button></div>
            <div class="p-6 space-y-4 overflow-y-auto custom-scroll">
                <div>
                    <label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">項目名稱</label>
                    <div class="flex gap-2">
                        <input type="text" id="gown-name" class="flex-1 border border-stone-200 rounded-xl p-3 text-sm focus:border-[#8C7B6E] outline-none" placeholder="例如：法式手工蕾絲婚紗">
                        <button onclick="aiGenerateDesc()" id="btn-ai-desc" class="bg-stone-100 text-[#8C7B6E] p-3 rounded-xl active:bg-[#8C7B6E] active:text-white transition-all">✨</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">種類</label><select id="gown-type" class="w-full border border-stone-200 rounded-xl p-3 text-sm bg-stone-50 outline-none"><option value="婚紗">婚紗</option><option value="晚裝">晚裝</option><option value="媽媽禮服">媽媽禮服</option><option value="旗袍裙褂">旗袍裙褂</option><option value="男士禮服">男士禮服</option></select></div>
                    <div><label class="text-[10px] font-bold text-stone-400 uppercase block mb-1">位置</label><input type="text" id="gown-location" class="w-full border border-stone-200 rounded-xl p-3 text-sm outline-none bg-stone-50" placeholder="櫃 A"></div>
                </div>
                <div><label class="text-[10px] font-bold text-stone-400 uppercase block mb-1 tracking-widest">✨ AI 工藝描述</label><textarea id="gown-desc" class="w-full border border-stone-200 rounded-xl p-4 text-sm h-28 outline-none resize-none bg-stone-50" placeholder="點擊 ✨ 生成專業描述..."></textarea></div>
                <button onclick="addGown()" class="w-full bg-[#8C7B6E] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">確認儲存</button>
            </div>
        </div>
    </div>

    <!-- 客人檔案 Modal -->
    <div id="modal-customer" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden fade-in max-h-[85vh] flex flex-col">
            <div class="bg-[#8C7B6E] p-5 text-white flex justify-between items-center shrink-0"><h3 class="font-bold serif">建立客人檔案</h3><button onclick="closeModal('modal-customer')" class="p-1"><i data-lucide="x"></i></button></div>
            <div class="p-6 space-y-5 overflow-y-auto custom-scroll">
                <input type="text" id="cust-name" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none shadow-sm" placeholder="新娘姓名">
                <input type="text" id="cust-phone" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none shadow-sm" placeholder="聯絡電話">
                <div><label class="text-[10px] font-bold text-stone-400 block mb-1.5 ml-1 uppercase">重要日期 (婚期/活動日)</label><input type="date" id="cust-date" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none bg-stone-50"></div>
                <textarea id="cust-notes" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm h-32 outline-none resize-none bg-stone-50" placeholder="備註細節..."></textarea>
                <button onclick="addCustomer()" class="w-full bg-[#8C7B6E] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">正式儲存</button>
            </div>
        </div>
    </div>

    <!-- 租借預約 Modal -->
    <div id="modal-rental" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden fade-in max-h-[85vh] flex flex-col">
            <div class="bg-[#8C7B6E] p-6 text-white flex justify-between items-center shrink-0"><h3 class="font-bold serif">預約登記</h3><button onclick="closeModal('modal-rental')" class="p-1"><i data-lucide="x"></i></button></div>
            <div class="p-6 space-y-6 overflow-y-auto custom-scroll">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1.5 ml-1 uppercase">選擇項目</label><select id="rent-gown" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none bg-stone-50"></select></div>
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1.5 ml-1 uppercase">選擇客人</label><select id="rent-cust" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none bg-stone-50"></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1.5 uppercase tracking-widest">取衫日期</label><input type="date" id="rent-start" onchange="checkConflicts()" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none"></div>
                    <div><label class="text-[10px] font-bold text-stone-400 block mb-1.5 uppercase tracking-widest">還衫日期</label><input type="date" id="rent-end" onchange="checkConflicts()" class="w-full border border-stone-200 rounded-xl p-3.5 text-sm outline-none"></div>
                </div>
                <div id="conflict-msg" class="hidden p-4 bg-red-50 text-red-600 text-[10px] font-bold rounded-xl flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> 此日期已被預約！</div>
                <button onclick="addRental()" id="btn-add-rental" class="w-full bg-[#8C7B6E] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-all">確認鎖定預約</button>
            </div>
        </div>
    </div>

    <!-- AI 助手彈窗 -->
    <div id="modal-ai-box" class="hidden fixed inset-0 z-[120] flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden fade-in flex flex-col max-h-[80vh] border-t-8 border-[#8C7B6E]">
            <div class="p-6 shrink-0 flex justify-between items-center bg-stone-50/50 border-b">
                <h3 class="font-bold flex items-center gap-2 text-stone-800 serif"><i data-lucide="sparkles" class="w-5 h-5 text-[#8C7B6E]"></i> AI 智能助手</h3>
                <button onclick="closeModal('modal-ai-box')" class="p-1 text-stone-300"><i data-lucide="x"></i></button>
            </div>
            <div class="flex-1 p-8 overflow-y-auto custom-scroll">
                <div id="ai-content-body" class="text-sm leading-relaxed text-stone-600 whitespace-pre-wrap italic"></div>
            </div>
            <div class="p-6 border-t border-stone-100 flex gap-3">
                <button onclick="copyToClipboard(document.getElementById('ai-content-body').innerText)" class="flex-1 bg-[#8C7B6E] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 flex items-center justify-center gap-2 text-sm"><i data-lucide="copy" class="w-4 h-4"></i> 複製</button>
                <button onclick="closeModal('modal-ai-box')" class="px-8 bg-stone-100 text-stone-400 rounded-2xl font-bold text-sm transition-all active:bg-stone-200">關閉</button>
            </div>
        </div>
    </div>

    <!-- 提醒中心 Modal -->
    <div id="modal-notifications" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl overflow-hidden fade-in border-t-8 border-red-400 flex flex-col max-h-[80vh]">
            <div class="p-6 shrink-0 flex justify-between items-center">
                <h3 class="text-xl serif font-bold flex items-center gap-2 text-stone-800"><i data-lucide="bell-ring" class="w-5 h-5 text-red-400"></i> 近期工作提醒</h3>
                <button onclick="closeModal('modal-notifications')" class="p-1"><i data-lucide="x"></i></button>
            </div>
            <div id="notif-list" class="flex-1 p-6 space-y-4 overflow-y-auto custom-scroll pt-0 pr-4"></div>
            <div id="notif-empty" class="hidden py-12 text-center text-stone-400 italic serif text-sm">目前所有預約狀態良好。</div>
            <div class="p-6 shrink-0 border-t border-stone-100">
                <button onclick="closeModal('modal-notifications')" class="w-full bg-stone-100 text-stone-600 py-3.5 rounded-xl font-bold active:bg-stone-200 transition-all">關閉視窗</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 安全認證與初始化 ---
        let firebaseConfig = {};
        try {
            const rawConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            firebaseConfig = rawConfig ? JSON.parse(rawConfig) : { apiKey: "preview", authDomain: "preview", projectId: "fenixclub-classic-tina" };
        } catch (e) { console.error("Config fail", e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fenixclub-classic-tina';
        const apiKey = ""; // Gemini API Key

        let gowns = [], customers = [], rentals = [];
        let currentUser = null;

        // --- 全域函數掛載 (確保 onclick 正常) ---
        window.openModal = (id) => {
            const el = document.getElementById(id);
            if (el) el.classList.remove('hidden');
            if (id === 'modal-rental') {
                document.getElementById('rent-gown').innerHTML = gowns.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                document.getElementById('rent-cust').innerHTML = customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }
            lucide.createIcons();
        };
        window.closeModal = (id) => document.getElementById(id)?.classList.add('hidden');
        window.forceRevealApp = () => { document.getElementById('loading-overlay').classList.add('hidden'); };
        window.copyAppUrl = () => {
            const el = document.createElement('textarea');
            el.value = window.location.href;
            document.body.appendChild(el); el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("網址已複製！請打開 Safari 並貼上。");
        };

        // --- ✨ Gemini AI 功能 ---
        const callGemini = async (prompt, system) => {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: system }] } })
                });
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (e) { return "AI 連線逾時，請再試一次。"; }
        };

        window.aiGenerateDesc = async () => {
            const name = document.getElementById('gown-name').value;
            if (!name) return alert("請先輸入名稱");
            const btn = document.getElementById('btn-ai-desc');
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 loading-spin"></i>';
            lucide.createIcons();
            const res = await callGemini(`為一件名為「${name}」的手工婚紗撰寫工藝描述。`, "你是一位資深禮服顧問。用繁體中文。");
            document.getElementById('gown-desc').value = res;
            btn.innerHTML = '✨';
        };

        window.aiDraftWhatsApp = async (id) => {
            const r = rentals.find(x => x.id === id);
            window.openModal('modal-ai-box');
            document.getElementById('ai-content-body').innerHTML = '<div class="shimmer h-32 w-full rounded-2xl"></div>';
            const res = await callGemini(`撰寫一段 WhatsApp 訊息提醒客人「${r.customerName}」於 ${r.startDate} 取件「${r.gownName}」。`, "你是一位親切的店長。用繁體中文。");
            document.getElementById('ai-content-body').innerText = res;
        };

        window.aiGetAdvice = async (id) => {
            const c = customers.find(x => x.id === id);
            window.openModal('modal-ai-box');
            document.getElementById('ai-content-body').innerHTML = '<div class="shimmer h-32 w-full rounded-2xl"></div>';
            const res = await callGemini(`根據備註「${c.notes || '無'}」，給這位準新娘三個形象專業建議。`, "你是一位高級形象顧問。用繁體中文。");
            document.getElementById('ai-content-body').innerText = res;
        };

        window.copyToClipboard = (text) => {
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el);
            el.select(); document.execCommand('copy');
            document.body.removeChild(el);
            alert("已複製到剪貼簿！");
        };

        // --- 資料連線與監聽 ---
        const startApp = async () => {
            const timeoutId = setTimeout(() => { if(!currentUser) document.getElementById('setup-error').classList.remove('hidden'); }, 8000);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        clearTimeout(timeoutId);
                        currentUser = user;
                        forceRevealApp();
                        document.getElementById('status-text').innerText = "Google 雲端已同步";
                        document.getElementById('status-dot').className = "w-1.5 h-1.5 bg-green-500 rounded-full";
                        setupListeners();
                    }
                });
            } catch (e) { 
                document.getElementById('status-text').innerText = "驗證逾時";
                document.getElementById('setup-error').classList.remove('hidden');
            }
        };

        function setupListeners() {
            onSnapshot(collection(db,'artifacts',appId,'public','data','gowns'), s => { gowns=s.docs.map(d=>({id:d.id,...d.data()})); renderInventory(); document.getElementById('gown-count').innerText=`${gowns.length} 件`; });
            onSnapshot(collection(db,'artifacts',appId,'public','data','customers'), s => { customers=s.docs.map(d=>({id:d.id,...d.data()})); renderCustomers(); processReminders(); document.getElementById('cust-count').innerText=`${customers.length} 人`; });
            onSnapshot(collection(db,'artifacts',appId,'public','data','rentals'), s => { rentals=s.docs.map(d=>({id:d.id,...d.data()})); renderRentals(); document.getElementById('rent-count').innerText=`${rentals.length} 筆`; });
        }

        // --- 介面功能渲染 ---
        window.handleGlobalSearch = () => { const t=document.getElementById('globalSearch').value; renderInventory(t); renderCustomers(t); };
        window.addGown = async () => { const n=document.getElementById('gown-name').value; if(!n) return; await addDoc(collection(db,'artifacts',appId,'public','data','gowns'),{ name:n, type:document.getElementById('gown-type').value, location:document.getElementById('gown-location').value, description:document.getElementById('gown-desc').value, status:'Available', createdAt:new Date().toISOString() }); closeModal('modal-gown'); document.getElementById('gown-name').value=''; };
        window.addCustomer = async () => { const n=document.getElementById('cust-name').value; if(!n) return; await addDoc(collection(db,'artifacts',appId,'public','data','customers'),{ name:n, phone:document.getElementById('cust-phone').value, weddingDate:document.getElementById('cust-date').value, notes:document.getElementById('cust-notes').value, createdAt:new Date().toISOString() }); closeModal('modal-customer'); };
        window.addRental = async () => { const gid=document.getElementById('rent-gown').value; const cname=document.getElementById('rent-cust').value; if(!gid||!cname) return; await addDoc(collection(db,'artifacts',appId,'public','data','rentals'),{ gownId:gid, gownName:gowns.find(x=>x.id===gid).name, customerName:cname, startDate:document.getElementById('rent-start').value, endDate:document.getElementById('rent-end').value, status:'Confirmed', createdAt:new Date().toISOString() }); closeModal('modal-rental'); };
        window.deleteDocHandler = async (col, id) => { if(confirm("確定刪除此資料？")) await deleteDoc(doc(db,'artifacts',appId,'public','data',col,id)); };
        window.checkConflicts = () => { const gid=document.getElementById('rent-gown').value; const s=document.getElementById('rent-start').value; const e=document.getElementById('rent-end').value; if(!gid||!s||!e) return; const hasC=rentals.some(r=>r.gownId===gid&&r.status!=='Returned'&&(new Date(s)<=new Date(r.endDate)&&new Date(e)>=new Date(r.startDate))); document.getElementById('conflict-msg').classList.toggle('hidden',!hasC); };
        window.exportToCSV = () => { let csv="\uFEFF庫存報表\n名稱,種類,位置\n"+gowns.map(g=>`"${g.name}","${g.type}","${g.location}"`).join("\n"); const link=document.createElement("a"); link.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); link.download=`Report_${new Date().toLocaleDateString()}.csv`; link.click(); };

        function renderInventory(term = '') {
            const filtered = gowns.filter(g => g.name.toLowerCase().includes(term.toLowerCase()));
            document.getElementById('inventory-table').innerHTML = filtered.map(g => `
                <tr class="hover:bg-stone-50/50 transition-colors text-xs">
                    <td class="px-5 py-4"><p class="font-bold text-stone-700">${g.name}</p><span class="text-[8px] text-[#8C7B6E] font-bold uppercase tracking-tighter">${g.type}</span></td>
                    <td class="px-5 py-4 text-center"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold border ${g.status==='Available'?'bg-green-50 text-green-600':'bg-blue-50 text-blue-600'}">${g.status==='Available'?'在庫':'租出'}</span></td>
                    <td class="px-5 py-4 text-stone-500 font-medium">${g.location || '-'}</td>
                    <td class="px-5 py-4 text-right"><button onclick="deleteDocHandler('gowns','${g.id}')" class="text-stone-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            document.getElementById('inventory-empty').classList.toggle('hidden', filtered.length > 0);
            lucide.createIcons();
        }

        function renderCustomers(term = '') {
            const filtered = customers.filter(c => c.name.toLowerCase().includes(term.toLowerCase()) || c.phone.includes(term));
            document.getElementById('customer-grid').innerHTML = filtered.map(c => `
                <div class="bg-white p-5 rounded-2xl border shadow-sm flex justify-between items-start">
                    <div><h3 class="font-bold text-stone-800 text-sm">${c.name}</h3><p class="text-[9px] text-stone-400 mt-1">${c.phone}</p><p class="text-[8px] font-bold text-[#8C7B6E] mt-3 uppercase tracking-widest">活動: ${c.weddingDate || '未定'}</p></div>
                    <div class="flex gap-2">
                        <button onclick="aiGetAdvice('${c.id}')" class="p-2 bg-stone-50 rounded-lg text-[#8C7B6E] active:scale-90 transition-all"><i data-lucide="sparkles" class="w-4 h-4"></i></button>
                        <button onclick="deleteDocHandler('customers','${c.id}')" class="p-2 text-stone-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('');
            document.getElementById('customers-empty').classList.toggle('hidden', filtered.length > 0);
            lucide.createIcons();
        }

        function renderRentals() {
            document.getElementById('rental-list').innerHTML = rentals.map(r => `
                <div class="bg-white border border-stone-200 p-4 rounded-2xl shadow-sm border-l-[6px] border-[#8C7B6E] flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div class="flex gap-3"><div class="w-9 h-9 bg-stone-50 rounded-lg flex items-center justify-center text-[#8C7B6E]"><i data-lucide="calendar-check" class="w-5 h-5"></i></div><div><h4 class="text-sm font-bold text-stone-800">${r.customerName}</h4><p class="text-[9px] text-stone-400">${r.gownName}</p></div></div>
                        <button onclick="aiDraftWhatsApp('${r.id}')" class="bg-white text-[#8C7B6E] border border-[#EBE3DC] px-3 py-1.5 rounded-xl text-[10px] font-bold flex items-center gap-1 active:scale-90 transition-all"><i data-lucide="sparkles" class="w-3 h-3"></i> AI 提醒</button>
                    </div>
                    <div class="bg-stone-50 px-3 py-2 rounded-xl font-bold text-stone-500 text-[10px] flex justify-between items-center"><span>${r.startDate} 至 ${r.endDate}</span><button onclick="deleteDocHandler('rentals','${r.id}')" class="text-stone-200"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>
                </div>
            `).join('');
            document.getElementById('rentals-empty').classList.toggle('hidden', rentals.length > 0);
            lucide.createIcons();
        }

        function processReminders() {
            const t=new Date(); t.setHours(0,0,0,0); const alerts=[];
            customers.forEach(c => { if(!c.weddingDate) return; const d=new Date(c.weddingDate); d.setHours(0,0,0,0); const diff=Math.ceil((d-t)/(1000*60*60*24)); if(diff===7) alerts.push({ name:c.name, type:'改裙', days:7, color:'blue' }); if(diff===4) alerts.push({ name:c.name, type:'取衫', days:4, color:'red' }); });
            if(alerts.length > 0) {
                document.getElementById('notif-badge').classList.remove('hidden');
                document.getElementById('notif-list').innerHTML = alerts.map(a => `<div class="p-4 rounded-xl bg-stone-50 border-l-4 ${a.color==='blue'?'border-blue-400':'border-red-400'} flex justify-between items-center mb-2"><h4 class="text-xs font-bold">${a.name} - ${a.type}</h4><span class="text-[10px] font-bold">剩 ${a.days} 天</span></div>`).join('');
                if(!window.notifDone) { openModal('modal-notifications'); window.notifDone=true; }
            }
        }

        window.addEventListener('load', () => { lucide.createIcons(); startApp(); });
    </script>
</body>
</html>
